<!DOCTYPE html>
<!-- #d7191c #fdae61 #ffffbf #abd9e9 #2c7bb6 -->
<html>
<head>
    <title>Google Map Integration</title>
    <link rel="stylesheet" type="text/css" href="style.css">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet"/>
</head>

<body>
<div id="container">
    <!--<div id="details"></div>-->
    <div id="search"></div>
    <div id="map"></div>
    <div id="addLocationButton">
        <input type="button" name="addLocationButton" value="Add Location" onclick="addLocation()" />
    </div>
    <div id="legend">
        <svg color>
            <rect x="1px" width="168px" height="50px" fill="rgb(255,255,255)" stroke-width="3" stroke="rgb(50,50,50)">

            </rect>
            <svg class="housing">
                <circle r="5.542562584220407" cx="15" cy="15"></circle>
                <text x="30" y="20">BHA Developments</text>
            </svg>
            <svg class="city-sites">
                <circle r="5.542562584220407" cx="15" cy="35"></circle>
                <text x="30" y="40">City Sites</text>
            </svg>
        </svg>

    </div>
</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.full.js"></script>
<script src="//maps.google.com/maps/api/js?key=AIzaSyC5OdRTk0wkjI93UcS2XrZBPg4JEzBKI7w"></script>
<script src="//d3js.org/d3.v4.min.js"></script>
</body>

<script src="js/map-style.js"></script>
<script type="text/javascript">

    // given all such possible elements, the list of those to highlight,
    // the function that extracts the field to compare with toHighlight,
    // the opacity of the ones in the field, and the others,
    // highlights nodes
    function highlight(all, toHighlight, extractor, unselectedOpacity, selectedOpacity) {
        all.transition()
            .filter(x => !!x)
            .attr("opacity", unselectedOpacity)
            // choose selected ones
            .filter(n => toHighlight.indexOf(extractor(n)) >= 0)
            // update their opacity
            .attr("opacity", selectedOpacity)
    }

    function setOpacity(chosen, opacity) {
        // sets the opacity of all given elements to the given opacity
        highlight(chosen, [], x => x, opacity, opacity)
    }

    function addLocation() {
        console.log('button clicked')
    }


    //attach search box listener
    $("#search").on("select2:select", function (event) {
        const selection = $("#search").select2("data");
        const toHighlight = selection.map(s => s.name);

        highlight(d3.selectAll("svg"), toHighlight, n => n.name, .2, 1);
        highlight(d3.selectAll("svg").selectAll("text"), toHighlight, n => n.text, 0, 1)

    }).on("select2:unselect", function (event) {
        const search = $("#search");
        const previousSelection = search.select2("data");

        const selected = previousSelection.map(s => s.name);
        const nodes = d3.selectAll("svg");
        const texts = nodes.selectAll("text");

        if (selected.length === 0) {
            // selection is empty, so reset all
            setOpacity(nodes, .8);
            setOpacity(texts, 0);
        } else {
            // highlight the nodes and text that are selected
            highlight(nodes, selected, n => n.name, .2, 1);
            highlight(texts, selected, n => n.text, 0, 1);
        }

        search.selected().trigger('change');
    });

    // Initiate map
    var map = new google.maps.Map(d3.select("#map").node(), {
        zoom: 12,
        center: new google.maps.LatLng(42.318643, -71.072642),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControl: false,
        draggableCursor: "crosshair",
        draggingCursor: "all-scroll"
    });

    // Start of boundary-limit code
    var strictBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(42.226019, -71.151599),
        new google.maps.LatLng(42.421625, -71.023096)
    );

    // Listen for the dragend event
    google.maps.event.addListener(map, 'dragend', function () {
        if (strictBounds.contains(map.getCenter())) return;

        // We're out of bounds - Move the map back within the bounds

        var c = map.getCenter(),
            x = c.lng(),
            y = c.lat(),
            maxX = strictBounds.getNorthEast().lng(),
            maxY = strictBounds.getNorthEast().lat(),
            minX = strictBounds.getSouthWest().lng(),
            minY = strictBounds.getSouthWest().lat();

        if (x < minX) x = minX;
        if (x > maxX) x = maxX;
        if (y < minY) y = minY;
        if (y > maxY) y = maxY;

        map.setCenter(new google.maps.LatLng(y, x));
    });

    // Zoom limits
    map.setOptions({minZoom: 11, maxZoom: 18});
    // End of boundary-limit code

    map.mapTypes.set('styled_map', styledMapType);
    map.setMapTypeId('styled_map');


    var select2data = [];
    var addNodes = function (filePath, attributes) {
        d3.json(filePath, function (error, data) {
            if (error) throw error;

            var clicked = false;

            // set up the data for select2
            var newSelect2Data = data;
            // create unique id's
            var i = 0;
            newSelect2Data.forEach(d => d.id = i++);
            // render each option as a name
            newSelect2Data.forEach(d => d.text = d.name);
            newSelect2Data.forEach(d => select2data.push(d));
            select2data.sort((a, b) => {
                if (a.text > b.text) return 1; else return 0
            });
            $("#search").select2({
                placeholder: 'Search for BHA Developments or program sites...',
                data: select2data,
                multiple: "multiple",
                containerCssClass: "search"
            });


            var overlay = new google.maps.OverlayView();
            // Add the container when the overlay is added to the map.
            overlay.onAdd = function () {
                var layer = d3.select(overlay.getPanes().overlayLayer)
                    .append("div")
                    .attr("class", attributes);

                // Draw each marker as a separate SVG element.
                // We could use a single SVG, but what size would it have?
                overlay.draw = function () {
                    var projection = overlay.getProjection();
                    var padding = 15;

                    function transform(d) {
                        d = new google.maps.LatLng(d.lat, d.long);
                        d = projection.fromLatLngToDivPixel(d);
                        return d3.select(this)
                            .style("left", (d.x - padding) + "px")
                            .style("top", (d.y - padding) + "px");
                    }

                    var tooltip = d3.select("body")
                    .append("div")
    	               .attr("class", "tooltip")
    	                .style("opacity", 0);

                    var info = d3.select("body")
                    .append("div")
    	               .attr("class", "info")
    	                .style("opacity", 0);

                    var marker = layer.selectAll("svg")
                        .data(data)
                        .each(transform) // update existing markers
                        .enter().append("svg")
                        .each(transform)
                        .attr("class", "marker");

                    function membersOrDefault(d) {
                        return Math.sqrt(d.members) / 5 || 4.5
                    }

                    marker.append("circle")
                        .attr("r", membersOrDefault)
                        .attr("cx", padding)
                        .attr("cy", padding)
                        .append("svg:title")
                        .text(d => d.description || "City Site Program")
                        .on("mouseover", function(d) {
                          console.log("hover")
                          tooltip.transition()
                          .duration(200)
                          .style("opacity", .9);
                          tooltip.html(d.name + '<br>' + d.address)
                          .style("left", (d3.event.pageX + 5) + "px")
                          .style("top", (d3.event.pageY - 28) + "px");
      	                 })
     	                   .on("mouseout", function(d) {
                           tooltip.transition()
                           .duration(200)
                           .style("opacity", 0);
                         })
                         .on("click", function(d) {
                           console.log("click")
                           if(clicked) {
                             clicked = false;
                             info.transition()
                             .duration(200)
                             .style("opacity", 0);
                           } else {
                             info.transition()
                             clicked = true;
                             info.transition()
                             .duration(200)
                             .style("opacity", .9)
                             info.html(d.name + '<br>' + d.address + '<br>' + d.website)
                             .style("left", (d3.event.pageX + 5) + "px")
                             .style("top", (d3.event.pageY - 28) + "px");
                           }
                         })

                    marker.append("text")
                        .attr("x", d => padding + 3 + membersOrDefault(d))
                        .attr("y", padding)
                        .attr("opacity", 0)
                        .attr("dy", ".31em")
                        .attr("width", "100px")
                        .text(function (d) {
                            return d.name;
                        });
                };
            };

            // Bind our overlay to the mapâ€¦
            overlay.setMap(map);
        });
    };

    addNodes("data/bha_housing_map_with_size.json", "housing");
    addNodes("data/city_sites_clean.json", "city-sites");
</script>
</html>
